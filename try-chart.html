<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bar Chart with Chart.js</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <label for="yearFilter">Select Year:</label>
    <select id="yearFilter">
      <option value="allYear">All Year</option>
      <option value="2014">2014</option>
      <option value="2015">2015</option>
      <option value="2016">2016</option>
      <option value="2017">2017</option>
    </select>
    <canvas id="myChart" width="400" height="200"></canvas>
    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        let chart; // To hold the chart instance

        const fetchData = () => {
          return fetch("data/dataset-superstore.json")
            .then((response) => response.json())
            .catch((error) => {
              console.error("Error fetching the dataset:", error);
              return [];
            });
        };

        const updateChart = (data, year) => {
          let filteredData;
          if (year === "All Year") {
            filteredData = data; // Use all data if 'All Year' is selected
          } else {
            filteredData = data.filter((item) => item.Year_Separated === year);
          }

          console.log(`Filtered data for year ${year}:`, filteredData);

          const segments = [];
          const sales = [];

          filteredData.forEach((item) => {
            if (!segments.includes(item.Segment)) {
              segments.push(item.Segment);
            }
          });

          segments.forEach((segment) => {
            const segmentSales = filteredData
              .filter((item) => item.Segment === segment)
              .reduce((sum, item) => sum + parseFloat(item.Sales), 0);
            sales.push(segmentSales);
          });

          console.log("Segments:", segments);
          console.log("Sales:", sales);

          const ctx = document.getElementById("myChart").getContext("2d");

          if (chart) {
            chart.destroy(); // Destroy the previous chart instance if it exists
          }

          chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: segments,
              datasets: [
                {
                  label:
                    year === "All Year"
                      ? "Sales by Segment (2014-2017)"
                      : `Sales by Segment for ${year}`,
                  data: sales,
                  backgroundColor: "rgba(75, 192, 192, 0.2)",
                  borderColor: "rgba(75, 192, 192, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        };

        fetchData().then((data) => {
          console.log("Fetched data:", data);

          const yearFilter = document.getElementById("yearFilter");

          yearFilter.addEventListener("change", () => {
            const selectedYear = yearFilter.value;
            updateChart(data, selectedYear);
          });

          // Initialize chart with all years (2014-2017)
          updateChart(data, "All Year");
        });
      });
    </script>
  </body>
</html>
